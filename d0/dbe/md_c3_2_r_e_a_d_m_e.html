<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Formula Student Electronics &amp; Software: TEENSYC3</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Formula Student Electronics &amp; Software
   </div>
   <div id="projectbrief">The code for the embedded software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d0/dbe/md_c3_2_r_e_a_d_m_e.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">TEENSYC3</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md12"></a> <img src="../../../docs/assets/c1-c3-overview/car-scheme.png" alt="Distribution of electronics in FSFEUP 01" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md13"></a>
Initial notes:</h1>
<p>TeensyC1 - Caixa 1 - Located inside PCBs box</p>
<p>TeensyC3 - Caixa 3 - Located behind DashBoard</p>
<p>BMS - Battery Management System - Inside TSAC</p>
<p>Bamocar - Inverter/Controller</p>
<p>APPS - Accelerator Pedal Position Sensor - Pedal Box</p>
<p>BL - Brake Light</p>
<h2><a class="anchor" id="autotoc_md14"></a>
TeensyC3 Functionalities:</h2>
<ul>
<li>APPS (Reading and check plausibility)</li>
<li>R2D (Logic + sound)</li>
<li>Display</li>
<li>Communication with Bamocar</li>
</ul>
<h1><a class="anchor" id="autotoc_md15"></a>
Main loop</h1>
<p>Inputs:</p>
<ul>
<li>APPS 1 (APPS_1_PIN, 41)</li>
<li>APPS 2 (APPS_2_PIN, 40)</li>
<li>R2D Button (R2D_PIN, 32) -&gt; uses <a href="https://github.com/thomasfredericks/Bounce2">Bounce2 Lib</a></li>
</ul>
<p>Outputs:</p>
<ul>
<li>Buzzer (buzzerPin, 4)</li>
</ul>
<p><img src="../../../docs/assets/c1-c3-overview/diagram-c3-mainloop.png" alt="C3 main loop diagram" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md16"></a>
Button Lib</h1>
<p><a href="https://github.com/thomasfredericks/Bounce2">Documentation</a> -&gt; The mechanical part of buttons and switches vibrate slightly when closed or opened causing multiple undesired false states (similar to noise). This library filters out these undesired state changes.</p>
<p>In this case, we only use the function fell() that returns true if the pin signal transitions from high to low since the last update.</p>
<h1><a class="anchor" id="autotoc_md17"></a>
TSOn</h1>
<p>TS means Tractive System. If TS is on, it is because the shutdown system is closed (everything has no errors and the pilot requests to turn on the TS). <br  />
 C3 Teensy knows that TS is on because Bamocar has one register that saves the DC voltage and if DC Voltage &gt; 0, that is because the TS is on.</p>
<h1><a class="anchor" id="autotoc_md18"></a>
CANSniffer</h1>
<p>This teensy also has a FIFO Filter</p>
<p>only accepts messages from:</p>
<ul>
<li>C1_ID (with Brake sensor value)</li>
<li>R2D_ID (this is just for debugging and override R2D logic aka setting R2D status to Driving)</li>
<li>BMS_ID (I think that this is not used)</li>
<li>BAMO_RESPONSE_ID (all messages from bamocar)</li>
</ul>
<h1><a class="anchor" id="autotoc_md19"></a>
R2D Logic</h1>
<h2><a class="anchor" id="autotoc_md20"></a>
R2D Rules:</h2>
<p><b>EV4.11.6</b></p>
<p>The vehicle is in Ready-to-drive (R2D) mode as soon as the motor(s) will respond to the input of the APPS.</p>
<p><b>EV4.11.7</b></p>
<p>After the TS has been activated, additional actions must be required by the driver to set the vehicle to R2D mode, e.g. pressing a dedicated start button. The transition to R2D mode must only be possible during the actuation of the mechanical brakes and a simultaneous dedicated additional action.</p>
<p><b>EV4.11.8</b></p>
<p>The R2D mode must be left immediately when the SDC is opened.</p>
<p>To enter the R2D logic all these conditions must be true:</p>
<ul>
<li>r2dButton.fell()<ul>
<li>The button on the dashboard has been pressed</li>
</ul>
</li>
<li>TSOn<ul>
<li>Already explained</li>
</ul>
</li>
<li>R2DTimer &lt; R2D_TIMEOUT<ul>
<li>Every time the brake sensor is pressed, the C1 teensy, reads the brake sensor value and sends it to the CAN BUS, Upon reading that message, C3 checks if the brake pressure is greater than a threshold (165) and if that is the case, the R2DTimer is reset.</li>
<li>This not only checks if the brake pedal has been pressed but also creates a small delay (R2D_TIMEOUT = 500 ms) to remove “bad timing”</li>
</ul>
</li>
</ul>
<p>If that is true:</p>
<ul>
<li>The R2D Sound that it is just:</li>
</ul>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="../../df/d60/statemachine_8hpp.html#a388b09d5f5d7c42d55d936befbbc7bcd">playR2DSound</a>() {</div>
<div class="line">    digitalWrite(<a class="code hl_define" href="../../df/d60/statemachine_8hpp.html#a302b1a44147b750d4db99416b7ce57ee">buzzerPin</a>, HIGH);</div>
<div class="line">    delay(1000);</div>
<div class="line">    digitalWrite(<a class="code hl_define" href="../../df/d60/statemachine_8hpp.html#a302b1a44147b750d4db99416b7ce57ee">buzzerPin</a>, LOW);</div>
<div class="line">}</div>
<div class="ttc" id="astatemachine_8hpp_html_a302b1a44147b750d4db99416b7ce57ee"><div class="ttname"><a href="../../df/d60/statemachine_8hpp.html#a302b1a44147b750d4db99416b7ce57ee">buzzerPin</a></div><div class="ttdeci">#define buzzerPin</div><div class="ttdef"><b>Definition</b> <a href="../../df/d60/statemachine_8hpp_source.html#l00009">statemachine.hpp:9</a></div></div>
<div class="ttc" id="astatemachine_8hpp_html_a388b09d5f5d7c42d55d936befbbc7bcd"><div class="ttname"><a href="../../df/d60/statemachine_8hpp.html#a388b09d5f5d7c42d55d936befbbc7bcd">playR2DSound</a></div><div class="ttdeci">void playR2DSound()</div><div class="ttdef"><b>Definition</b> <a href="../../df/d60/statemachine_8hpp_source.html#l00046">statemachine.hpp:46</a></div></div>
</div><!-- fragment --><ul>
<li>initBamocarD3<ol type="1">
<li>Clear bamocar errors <code>c++ can1.write(clearErrors); </code></li>
</ol>
</li>
<li>1. Turn on Bamocar Transmission <code>c++ while (not transmissionEnabled and CANTimer &gt; CANTimeoutMS) { can1.write(transmissionRequestEnable); CANTimer = 0; } </code></li>
<li>1. Check if BTBReady is true (BTBReady True means ready for operation) <code>c++ while (not BTBReady and CANTimer &gt; CANTimeoutMS) { can1.write(BTBStatus); CANTimer = 0; } </code></li>
<li>1. Enable the driver to respond to the APPS signal (<a href="https://drive.google.com/file/d/1AB3R3GgfrNnoZevtf9uZ19a8wwtScbqD/view?usp=sharing">Bamocar documentation page 27</a>) <code>c++ can1.write(noDisable); </code></li>
</ul>
<h2><a class="anchor" id="autotoc_md21"></a>
Notes about BTBReady:</h2>
<p>When we receive a message from BAMOCAR (the id is BAMO_RESPONSE_ID) and the content (msg.buf) equals the predefined message “BTBResponse” the BTBReady variable is set to true. <br  />
 This message “BTBResponse” was defined based on <a href="https://drive.google.com/file/d/1UVcGhsBRz_DpuVszRFBb6By628RkIuaZ/view?usp=sharing">this</a> document, page 19 shows two routine examples here we can see the expected response when BTB is closed (ready for operation).</p>
<h1><a class="anchor" id="autotoc_md22"></a>
request_dataLog_messages()</h1>
<p>This function enables a set of values from the BAMOCAR to be sent to the CAN BUS periodically.</p>
<p><img src="../../../docs/assets/c1-c3-overview/request-datalog-print.png" alt="Print" class="inline"/></p>
<p>Even though the logging itself is performed in the C1 teensy, these messages are requested here to only start the logging when the car is in R2D mode.</p>
<h1><a class="anchor" id="autotoc_md23"></a>
APPS</h1>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_variable" href="../../df/d60/statemachine_8hpp.html#a9a30ca7efc265b3b029dda392fc27e6f">APPSTimer</a> &gt; <a class="code hl_define" href="../../df/d60/statemachine_8hpp.html#a440488361fc9dad4d2c6f5fe149a8a4a">APPS_READ_PERIOD_MS</a>) {</div>
<div class="line">    <a class="code hl_variable" href="../../df/d60/statemachine_8hpp.html#a9a30ca7efc265b3b029dda392fc27e6f">APPSTimer</a> = 0;</div>
<div class="line">    <span class="keywordtype">int</span> apps_value = <a class="code hl_function" href="../../da/d81/apps_8h.html#aa0b17a93999463751af07de85755aaa7">readApps</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (apps_value &gt;= 0)</div>
<div class="line">    <a class="code hl_function" href="../../dc/d82/c3_2include_2can_8h.html#a57b07db127dcd19f98ec4926f8e09d6c">sendTorqueVal</a>(apps_value);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    <a class="code hl_function" href="../../dc/d82/c3_2include_2can_8h.html#a57b07db127dcd19f98ec4926f8e09d6c">sendTorqueVal</a>(0);</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">}</div>
<div class="ttc" id="aapps_8h_html_aa0b17a93999463751af07de85755aaa7"><div class="ttname"><a href="../../da/d81/apps_8h.html#aa0b17a93999463751af07de85755aaa7">readApps</a></div><div class="ttdeci">int readApps()</div><div class="ttdef"><b>Definition</b> <a href="../../da/dd7/apps_8cpp_source.html#l00082">apps.cpp:82</a></div></div>
<div class="ttc" id="ac3_2include_2can_8h_html_a57b07db127dcd19f98ec4926f8e09d6c"><div class="ttname"><a href="../../dc/d82/c3_2include_2can_8h.html#a57b07db127dcd19f98ec4926f8e09d6c">sendTorqueVal</a></div><div class="ttdeci">void sendTorqueVal(int value_bamo)</div><div class="ttdef"><b>Definition</b> <a href="../../db/dac/can_8cpp_source.html#l00218">can.cpp:218</a></div></div>
<div class="ttc" id="astatemachine_8hpp_html_a440488361fc9dad4d2c6f5fe149a8a4a"><div class="ttname"><a href="../../df/d60/statemachine_8hpp.html#a440488361fc9dad4d2c6f5fe149a8a4a">APPS_READ_PERIOD_MS</a></div><div class="ttdeci">#define APPS_READ_PERIOD_MS</div><div class="ttdef"><b>Definition</b> <a href="../../df/d60/statemachine_8hpp_source.html#l00019">statemachine.hpp:19</a></div></div>
<div class="ttc" id="astatemachine_8hpp_html_a9a30ca7efc265b3b029dda392fc27e6f"><div class="ttname"><a href="../../df/d60/statemachine_8hpp.html#a9a30ca7efc265b3b029dda392fc27e6f">APPSTimer</a></div><div class="ttdeci">elapsedMillis APPSTimer</div><div class="ttdef"><b>Definition</b> <a href="../../df/d60/statemachine_8hpp_source.html#l00030">statemachine.hpp:30</a></div></div>
</div><!-- fragment --><p> This is a diagram of the <a class="el" href="../../da/d81/apps_8h.html#aa0b17a93999463751af07de85755aaa7">readApps()</a> function:</p>
<p><img src="../../../docs/assets/c1-c3-overview/diagram-read-apps.png" alt="readAPPS diagram" class="inline"/></p>
<p>These are the real values of apps:</p>
<p><img src="../../../docs/assets/c1-c3-overview/graph-apps-travel.png" alt="APPS Graph" class="inline"/></p>
<p>This image is just an example to show the meaning of the variables used in the code.</p>
<p><img src="../../../docs/assets/c1-c3-overview/graph-apps2.jpg" alt="APPS Graph Example" class="inline"/></p>
<p>This has been removed in the 2024 FSG Rules but this code implements this feature. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
